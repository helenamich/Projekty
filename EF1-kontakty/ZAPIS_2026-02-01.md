# Zápis – 2026-02-01 (Kontakty EF1 čištění)

## Zadání od začátku (co stavíme)
Stavíme **kompletní sjednocenou databázi kontaktů** napříč více programy EF1 do jednoho „master“ CSV pro import do Airtable.

### Výstup (finální struktura)
Jedna tabulka v souboru `kontakty_unified.csv` se sloupci:
- `Jméno`
- `Příjmení`
- `Email` (unikátní klíč pro merge)
- `Oslovení`
- `Telefon`
- `LinkedIn profil` (jen přímé LinkedIn URL, žádné Google search odkazy)
- `Pracovní pozice`
- `Společnost / Firma`
- `Účastnil se` (programy, comma-separated; DLM 1–6 sjednoceno)
- `HR kontakt` (vytěženo z poznámek – jméno/email/role pokud šlo)
- `Stav` (např. Aktivní/Bounced podle historického seznamu)

### Vstupy (co mergujeme)
Více exportů ve složce (typicky „… - List 1.csv“), např.:
- `ACA 2024 - List 1.csv`
- `AILM - List 1.csv`
- `dlm 1-4.csv`, `DLM5.csv`, `dlm6.csv` (+ konsolidace do „DLM 1-6 (2021-2023)“)
- `DLM7 - List 1.csv`
- `FAIL - jaro 2025 - List 1.csv`
- `FAIL - podzim 2025 - List 1.csv`

K tomu doplňkové zdroje/utility:
- `merged_emails_old_dlm_2024 vcetne bounced.csv` → `Stav`
- `Master kontakty - Vánoce 2025 - kopie (3) (2).xlsx` → doplnění `linkedin_url` a `job_title` podle emailu

### Pravidla merge / čištění (hlavní)
- **Merge klíč**: email (normalizace na lowercase, první validní email pokud je jich víc v buňce).
- **Dedup**: pro stejného člověka se slučují údaje; pole typu programů se agregují.
- **Účastnil se**: programy se **konkatenují**, DLM 1–6 se sjednotí do `DLM 1-6 (2021-2023)`.
- **LinkedIn**: ukládat pouze **přímé profily** (`linkedin.com/in/...`), Google search URL se vyhazují.
- **HR kontakt**: vytěžení z „poznámek“ (interní poznámka / poznámka k fakturaci atd.) přes regexy.
- **Stav**: doplnění podle seznamu bounced emailů.

## Co jsme dnes udělali (chronologicky)

### 1) Apify doplňování pozic z LinkedIn – ale jen když opravdu chybí
- Vyhledali jsme kontakty v `kontakty_unified.csv`, které mají vyplněný `LinkedIn profil` a prázdný `Pracovní pozice`.
- Průběžně jsme drželi seznam v `kontakty_linkedin_bez_pozice.csv`.
- Upravili jsme `update_linkedin_positions.py`, aby:
  - **nepřepisoval existující pozice**,
  - doplňoval pozici jen když má kontakt LinkedIn a pozice chybí,
  - bral **jen job title** (primárně z `currentPosition/title`, a fallback z headline jen když vypadá jako „job title“, ne citát / osobní text),
  - respektoval kontrolu shody firmy (když je firma v CSV vyplněná).
- Proběhly běhy s logy v `update_linkedin_jobtitle_log.txt` a `update_linkedin_log.txt`.

### 2) Oprava: proč v unified chyběly pozice z `FAIL - podzim 2025 - List 1.csv`
- Našli jsme chybu v `merge_contacts.py`: pro `FAIL - podzim 2025` bylo mapování pozice špatně (`pozice: None`).
- Opravili jsme mapování tak, že pozice se bere z **více možných sloupců**: `pozice: [6, 15]` (vezme první neprázdný).
- Upravili jsme merge logiku v `merge_contacts.py`, aby `pozice` uměla být i seznam sloupců.
- Znovu jsme spustili `merge_contacts.py` → přegeneroval se `kontakty_unified.csv` a výrazně se zvedlo pokrytí pozic z FAIL podzim 2025.

### 3) Doplnění z Excelu „Master kontakty – Vánoce 2025“
- Načetli jsme `Master kontakty - Vánoce 2025 - kopie (3) (2).xlsx` (sheet `Sheet1`).
  - `job_title` je ve sloupci 9, `linkedin_url` ve sloupci 12, email je ve sloupci 1 (detekováno).
  - Do prostředí jsme doinstalovali `openpyxl`.
- Podle shody na email jsme do `kontakty_unified.csv` doplnili:
  - **+42** LinkedIn URL
  - **+29** pracovních pozic (job titles)
- Udělali jsme zálohu před doplněním: `kontakty_unified.before_master_xlsx.csv`.

## Stav na konci dne
- `kontakty_unified.csv` je doplněné o:
  - pozice z `FAIL - podzim 2025` (opravené mapování),
  - LinkedIn + pozice z Master XLSX (podle emailu),
  - část doplněných job titles přes Apify (jen tam, kde opravdu chyběly).
- `kontakty_linkedin_bez_pozice.csv` je aktualizovaný seznam kontaktů, kde je LinkedIn URL, ale pořád chybí pozice.

## Co zítra (návrh pokračování)
- Projít `kontakty_linkedin_bez_pozice.csv`:
  - rozhodnout, jestli zkusit jiný zdroj/actor pro spolehlivější „current position“,
  - případně doplnit ručně / jiným zdrojem.
- Navázat Airtable import (až bude databáze „ready“).

